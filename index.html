import React, { useState, useEffect } from 'react';
import { Calculator, FileText, Copy, Check, ExternalLink } from 'lucide-react';

const NotaryCalculator = () => {
  // 取得今日民國日期字串 (YYY/MM/DD)
  const getTodayROCString = () => {
    const date = new Date();
    const rocYear = date.getFullYear() - 1911;
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${rocYear}/${month}/${day}`;
  };

  // 狀態管理：改為純文字輸入
  const [receiveDate, setReceiveDate] = useState(getTodayROCString());
  const [closeDate, setCloseDate] = useState(getTodayROCString());
  const [archiveDate, setArchiveDate] = useState(getTodayROCString());
  
  // 類別狀態
  // 1: 永久類, 2: 其他公證類, 3: 其他認證類, 4: 未作成類
  const [category, setCategory] = useState('1'); 
  
  // 特殊條件狀態
  const [isContinuous, setIsContinuous] = useState(false);
  const [expirationDate, setExpirationDate] = useState('');

  // 複製狀態提示
  const [copied, setCopied] = useState(false);

  // 計算結果狀態
  const [result, setResult] = useState({
    startDateStr: '',
    retentionStr: '',
    destructionDateStr: '',
    status: 'ready'
  });

  // 輔助函式：嘗試從文字中解析年份 (抓取開頭的數字)
  const parseYearFromText = (text) => {
    if (!text) return 0;
    const year = parseInt(text);
    return isNaN(year) ? 0 : year;
  };

  // 輔助函式：格式化使用者輸入的日期為 YYY年MM月DD日
  const formatUserDate = (text) => {
    if (!text) return '';
    if (text.includes('年')) return text;
    
    const parts = text.split(/[\/\.\-\s]+/);
    if (parts.length === 3) {
      return `${parts[0]}年${parts[1]}月${parts[2]}日`;
    }
    return text;
  };

  // 核心計算邏輯
  useEffect(() => {
    calculateRetention();
  }, [category, isContinuous, archiveDate, expirationDate]);

  const calculateRetention = () => {
    // 檢查必要欄位
    if ((category === '2' || category === '3') && isContinuous && !expirationDate) {
      setResult(prev => ({ ...prev, status: 'missing_input' }));
      return;
    }

    let retentionStr = '';
    let startYear = 0;
    let destructionDateStr = '';
    
    const archiveYear = parseYearFromText(archiveDate);
    const expirationYear = parseYearFromText(expirationDate);

    // 判斷保存年限與起算基準
    if (category === '1') {
      // 永久類
      retentionStr = '永久';
      startYear = archiveYear + 1;
      destructionDateStr = '無';
    } else if (category === '4') {
      // 未作成類
      retentionStr = '5年';
      startYear = archiveYear + 1;
      const destroyYear = startYear + 5;
      destructionDateStr = `${destroyYear}年01月01日`;
    } else {
      // 其他公證類 (2) 或 其他認證類 (3)
      const isNotary = category === '2';
      const years = isNotary ? 15 : 10;
      retentionStr = `${years}年`;

      if (isContinuous) {
        // 繼續性：起算 = 期限屆至年 + 1
        startYear = expirationYear + 1;
      } else {
        // 非繼續性：起算 = 歸檔年 + 1
        startYear = archiveYear + 1;
      }

      const destroyYear = startYear + years;
      destructionDateStr = `${destroyYear}年01月01日`;
    }

    setResult({
      startDateStr: `${startYear}年`,
      retentionStr: retentionStr,
      destructionDateStr: destructionDateStr,
      status: 'success'
    });
  };

  // 複製功能
  const copyToClipboard = () => {
    const textToCopy = `收案日期 ${formatUserDate(receiveDate)}
結案日期 ${formatUserDate(closeDate)}
歸檔日期 ${formatUserDate(archiveDate)}
保存年限起算 ${result.startDateStr}
保存年限 ${result.retentionStr}
預定銷燬日期：${result.destructionDateStr}`;
    
    navigator.clipboard.writeText(textToCopy);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  // 條件渲染輔助
  const showContinuousOption = category === '2' || category === '3';
  const showExpirationInput = showContinuousOption && isContinuous;

  return (
    <div className="min-h-screen bg-slate-50 py-8 px-4 font-sans text-slate-800">
      <div className="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200 flex flex-col min-h-[800px]">
        
        {/* Header */}
        <div className="bg-slate-800 p-6 text-white flex items-center justify-between flex-shrink-0">
          <div>
            <h1 className="text-2xl font-bold tracking-wide flex items-center gap-2">
              <Calculator className="h-6 w-6 text-blue-400" />
              公證保存年限計算機
            </h1>
            <p className="text-slate-400 text-sm mt-1">民間公證人專用工具</p>
          </div>
        </div>

        <div className="grid md:grid-cols-12 gap-0 flex-grow">
          
          {/* 左側：輸入區 */}
          <div className="md:col-span-7 p-6 space-y-8 border-b md:border-b-0 md:border-r border-slate-200">
            
            {/* 1. 基礎日期設定 */}
            <section>
              <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2">
                <FileText className="h-4 w-4" /> 案件日期設定
                <span className="text-xs font-normal text-slate-400 normal-case ml-1">(日期皆為民國)</span>
              </h3>
              <div className="space-y-4">
                <TextInput 
                  label="收案日期" 
                  value={receiveDate} 
                  onChange={setReceiveDate} 
                  placeholder="例：113/01/01"
                />
                <TextInput 
                  label="結案日期" 
                  value={closeDate} 
                  onChange={setCloseDate} 
                  placeholder="例：113/01/01"
                />
                <TextInput 
                  label="歸檔日期" 
                  value={archiveDate} 
                  onChange={setArchiveDate} 
                  placeholder="例：113/01/01"
                  highlight
                />
              </div>
            </section>

            {/* 2. 類別選擇 */}
            <section>
              <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2">
                <FileText className="h-4 w-4" /> 第一層：案件種類
              </h3>
              <div className="grid grid-cols-1 gap-3">
                <RadioOption 
                  id="cat1" value="1" checked={category === '1'} onChange={setCategory}
                  title="(一) 永久類（包括公證及認證）"
                  desc={[
                    "案由物權：不動產物權得喪變更",
                    "案由親屬：婚姻、認領、收養、其他涉及親屬關係",
                    "案由繼承：遺囑或遺產處分行為"
                  ]}
                />
                <RadioOption 
                  id="cat2" value="2" checked={category === '2'} onChange={setCategory}
                  title="(二) 其他公證類"
                  desc={[
                    "案由債權：買賣、租賃、借貸、委任授權、其他",
                    "案由其他"
                  ]}
                />
                <RadioOption 
                  id="cat3" value="3" checked={category === '3'} onChange={setCategory}
                  title="(三) 其他認證類"
                  desc={[
                    "案由單身：單身大陸、單身其他",
                    "案由債權：買賣、租賃、借貸、委任授權、其他",
                    "案由私文書認證其他",
                    "案由公文書",
                    "案由繕影本",
                    "案由翻譯本",
                    "案由其他"
                  ]}
                />
                <RadioOption 
                  id="cat4" value="4" checked={category === '4'} onChange={setCategory}
                  title="(四) 未作成類（包括公證及認證）"
                />
              </div>
            </section>

            {/* 3. 特殊條件 (動態顯示) */}
            {showContinuousOption && (
              <section className="bg-blue-50 p-4 rounded-lg border border-blue-100 animate-in fade-in slide-in-from-top-4 duration-300">
                <div className="mb-2">
                  <p className="text-sm text-slate-700 font-medium mb-1">是否為繼續性法律行為？</p>
                  <p className="text-xs text-slate-500 mb-3 leading-relaxed">
                    註：有確定履行期限、定有存續期間的法律行為，自期間屆滿翌年1月1日起算。
                  </p>
                  
                  <div className="flex gap-4">
                    <label className="flex items-center gap-2 cursor-pointer text-sm">
                      <input 
                        type="radio" 
                        name="continuous" 
                        checked={!isContinuous} 
                        onChange={() => setIsContinuous(false)}
                        className="w-4 h-4 text-blue-600 focus:ring-blue-500"
                      />
                      <span>非繼續性 (預設)</span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer text-sm">
                      <input 
                        type="radio" 
                        name="continuous" 
                        checked={isContinuous} 
                        onChange={() => setIsContinuous(true)}
                        className="w-4 h-4 text-blue-600 focus:ring-blue-500"
                      />
                      <span className="font-semibold text-blue-700">繼續性</span>
                    </label>
                  </div>
                </div>

                {showExpirationInput && (
                  <div className="mt-4 pt-4 border-t border-blue-200">
                    <TextInput 
                      label="期限屆至日期" 
                      value={expirationDate} 
                      onChange={setExpirationDate}
                      required
                      placeholder="例：118/12/31"
                      helperText="繼續性法律行為以此日為起算基準"
                    />
                  </div>
                )}
              </section>
            )}

          </div>

          {/* 右側：結果輸出區 */}
          <div className="md:col-span-5 bg-slate-100 p-6 flex flex-col justify-center">
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 sticky top-6">
              <div className="flex items-center justify-between border-b pb-4 mb-4">
                <h2 className="text-lg font-bold text-slate-800">
                  計算結果
                </h2>
                <button
                  onClick={copyToClipboard}
                  className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-md transition-colors"
                >
                  {copied ? <Check className="h-3.5 w-3.5" /> : <Copy className="h-3.5 w-3.5" />}
                  {copied ? '已複製' : '複製結果'}
                </button>
              </div>

              {/* 純文字結果顯示區 */}
              <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 font-mono text-sm leading-relaxed text-slate-800">
                <div className="space-y-3">
                  <div className="grid grid-cols-[100px_1fr] gap-2">
                    <span className="text-slate-500 select-none">收案日期</span>
                    <span className="font-medium">{formatUserDate(receiveDate)}</span>
                  </div>
                  
                  <div className="grid grid-cols-[100px_1fr] gap-2">
                    <span className="text-slate-500 select-none">結案日期</span>
                    <span className="font-medium">{formatUserDate(closeDate)}</span>
                  </div>
                  
                  <div className="grid grid-cols-[100px_1fr] gap-2">
                    <span className="text-slate-500 font-bold select-none">歸檔日期</span>
                    <span className="font-bold">{formatUserDate(archiveDate)}</span>
                  </div>
                  
                  {showExpirationInput && (
                    <div className="grid grid-cols-[100px_1fr] gap-2 text-blue-700">
                      <span className="select-none">期限屆至</span>
                      <span className="font-medium">{formatUserDate(expirationDate)}</span>
                    </div>
                  )}

                  <div className="my-2 border-t border-slate-200 border-dashed"></div>

                  <div className="grid grid-cols-[100px_1fr] gap-2">
                    <span className="text-slate-500 select-none">保存年限起算</span>
                    <span className="font-bold text-blue-700">
                      {result.status === 'missing_input' ? '---' : result.startDateStr}
                    </span>
                  </div>
                  
                  <div className="grid grid-cols-[100px_1fr] gap-2">
                    <span className="text-slate-500 select-none">保存年限</span>
                    <span className="font-bold">
                       {result.retentionStr}
                    </span>
                  </div>
                  
                  <div className="grid grid-cols-[100px_1fr] gap-2">
                    <span className="text-slate-500 select-none">預定銷燬日期</span>
                    <span className="font-bold text-red-600">
                      {result.status === 'missing_input' ? '---' : result.destructionDateStr}
                    </span>
                  </div>
                </div>
              </div>
              
              <p className="text-xs text-slate-400 mt-3 text-center">
                * 右上角按鈕可一鍵複製文字
              </p>

            </div>
          </div>
        </div>

        {/* Footer Link */}
        <div className="bg-slate-50 p-4 border-t border-slate-200 text-center flex-shrink-0">
            <a 
              href="https://law.moj.gov.tw/LawClass/LawAll.aspx?pcode=A0030180" 
              target="_blank" 
              rel="noreferrer" 
              className="inline-flex items-center gap-1 text-xs text-slate-400 hover:text-blue-600 hover:underline"
            >
                參考法規 公證文書簿冊保存及銷燬規則
                <ExternalLink className="h-3 w-3" />
            </a>
        </div>
      </div>
    </div>
  );
};

// --- Sub Components ---

const TextInput = ({ label, value, onChange, placeholder, highlight = false, required = false, helperText }) => {
  return (
    <div className={`relative ${highlight ? 'bg-yellow-50/50 -mx-2 px-2 py-2 rounded-md' : ''}`}>
      <label className="block text-sm font-medium text-slate-700 mb-1">
        {label} {required && <span className="text-red-500">*</span>}
      </label>
      <input 
        type="text" 
        value={value} 
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
        className={`
          block w-full rounded-md border-slate-300 shadow-sm 
          focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border
          ${required && !value ? 'border-red-300 ring-1 ring-red-200' : ''}
        `}
      />
      {helperText && <p className="text-xs text-blue-600 mt-1">{helperText}</p>}
    </div>
  );
};

const RadioOption = ({ id, value, checked, onChange, title, desc }) => (
  <label 
    htmlFor={id}
    className={`
      flex items-start p-3 border rounded-lg cursor-pointer transition-all select-none
      ${checked ? 'bg-blue-50 border-blue-500 ring-1 ring-blue-500' : 'hover:bg-slate-50 border-slate-200'}
    `}
  >
    <div className="flex h-5 items-center mt-0.5">
      <input
        id={id}
        name="category"
        type="radio"
        value={value}
        checked={checked}
        onChange={(e) => onChange(e.target.value)}
        className="h-4 w-4 border-slate-300 text-blue-600 focus:ring-blue-500"
      />
    </div>
    <div className="ml-3 text-sm flex-1">
      <span className={`font-medium block ${checked ? 'text-blue-900' : 'text-slate-900'}`}>
        {title}
      </span>
      {desc && Array.isArray(desc) && (
        <div className={`mt-1.5 space-y-1 ${checked ? 'text-blue-700' : 'text-slate-500'}`}>
          {desc.map((line, idx) => (
            <div key={idx} className="text-xs border-l-2 border-slate-300/50 pl-2 leading-tight">
              {line}
            </div>
          ))}
        </div>
      )}
      {desc && !Array.isArray(desc) && (
         <p className={`mt-0.5 ${checked ? 'text-blue-700' : 'text-slate-500'}`}>
          {desc}
        </p>
      )}
    </div>
  </label>
);

export default NotaryCalculator;